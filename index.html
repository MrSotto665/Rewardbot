<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Secret Meet - Premium Chat</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --primary: #ff0080;
            --secondary: #7928ca;
            --bg-dark: #0a0b1e;
            --glass: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-muted: #a0a0b8;
        }

        body { 
            background: radial-gradient(circle at top right, #1a1b3a, #0a0b1e); 
            color: var(--text-main); 
            font-family: 'Inter', -apple-system, sans-serif; 
            margin: 0; 
            overflow: hidden; 
            height: 100vh;
        }

        #app { display: flex; flex-direction: column; height: 100vh; }

        /* Header Styling */
        .header { 
            background: rgba(15, 12, 41, 0.8);
            backdrop-filter: blur(15px);
            padding: 18px; 
            text-align: center; 
            font-size: 1.1rem;
            font-weight: 800; 
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(255, 0, 128, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        /* Home Screen Styling */
        #home-screen { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 30px;
            animation: fadeIn 0.8s ease;
        }

        .hero-icon {
            font-size: 60px;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 15px var(--primary));
        }

        .btn-main { 
            padding: 16px 50px; 
            border-radius: 30px; 
            border: none; 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color: white; 
            font-size: 17px; 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.3s;
            box-shadow: 0 8px 25px rgba(255, 0, 128, 0.4);
            margin-top: 20px;
        }
        .btn-main:active { transform: scale(0.95); box-shadow: 0 4px 10px rgba(255, 0, 128, 0.2); }

        /* Chat Screen Styling */
        #chat-screen { flex: 1; display: none; flex-direction: column; background: transparent; position: relative; }
        
        #messages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            gap: 12px;
            scroll-behavior: smooth;
        }

        /* Bubbles Upgrade */
        .msg { 
            padding: 12px 18px; 
            border-radius: 18px; 
            max-width: 80%; 
            font-size: 15px; 
            line-height: 1.5; 
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .me { 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            align-self: flex-end; 
            border-bottom-right-radius: 4px;
        }
        .partner { 
            background: var(--glass); 
            backdrop-filter: blur(10px);
            align-self: flex-start; 
            border-bottom-left-radius: 4px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        /* Input Bar Upgrade */
        .input-area { 
            padding: 15px; 
            background: rgba(10, 11, 30, 0.9);
            backdrop-filter: blur(20px);
            display: flex; 
            gap: 10px;
            align-items: center; 
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        input { 
            flex: 1; 
            padding: 12px 20px; 
            border-radius: 25px; 
            border: 1px solid rgba(255,255,255,0.1); 
            background: rgba(255,255,255,0.05); 
            color: white; 
            outline: none;
            transition: 0.3s;
        }
        input:focus { border-color: var(--primary); background: rgba(255,255,255,0.08); }

        .send-btn { 
            background: var(--primary); 
            color: white; 
            border: none; 
            width: 45px; height: 45px; 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(255, 0, 128, 0.3);
        }

        /* Action Buttons */
        .stop-chat { 
            color: #ff4d4d; 
            font-size: 13px; 
            font-weight: 600;
            padding: 10px; 
            background: transparent; 
            border: none;
            opacity: 0.8;
        }

        .end-options { 
            display: flex; flex-direction: column; gap: 12px;
            padding: 25px; background: var(--glass); 
            backdrop-filter: blur(20px); border-radius: 20px; 
            margin: 20px; border: 1px solid rgba(255, 0, 128, 0.2);
            animation: slideUp 0.4s ease;
        }
        .btn-next { background: #00d2ad; color: white; border: none; padding: 14px; border-radius: 15px; font-weight: 700; }
        .btn-exit { background: rgba(255, 255, 255, 0.1); color: white; border: none; padding: 14px; border-radius: 15px; font-weight: 700; }

        .status-msg { font-size: 12px; color: var(--text-muted); text-align: center; margin: 10px 0; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <div id="app">
        <div class="header">
            <span>üíñ</span> SECRET MEET LIVE
        </div>
        
        <div id="home-screen">
            <div class="hero-icon">üé≠</div>
            <h1 style="margin: 0; font-size: 24px;">Ready to Mingle?</h1>
            <p style="color: var(--text-muted); margin-top: 10px;">Connect anonymously with random people around the world.</p>
            <button class="btn-main" id="findBtn" onclick="findPartner()">üîç Start Searching</button>
            <p id="status-text" style="margin-top: 20px; font-size: 14px; color: var(--primary);">‚óè Online & Ready</p>
        </div>

        <div id="chat-screen">
            <div id="messages"></div>
            <div style="text-align: center;" id="stop-btn-container">
                <button class="stop-chat" onclick="endChatLocal()">Disconnect Chat</button>
            </div>
            <div class="input-area" id="input-container">
                <input id="minput" type="text" placeholder="Write a message..." onkeypress="if(event.key==='Enter') sendMsg()">
                <button class="send-btn" onclick="sendMsg()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const socket = io({ transports: ['websocket'], upgrade: false });
        const userId = tg.initDataUnsafe?.user?.id;

        tg.expand();
        tg.ready();
        tg.headerColor = "#0f0c29";

        if (userId) socket.emit('join', userId);

        ffunction findNextPartner() {
            // ‡¶Ø‡¶¶‡¶ø ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∏‡ßá‡¶∂‡¶® ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡ßá ‡¶•‡ßá‡¶ï‡ßá ‡¶Ø‡¶æ‡ßü ‡¶§‡¶æ ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ
            if (userId) {
                socket.emit('leave_chat', userId); 
            }
            
            document.getElementById('chat-screen').style.display = 'none';
            document.getElementById('home-screen').style.display = 'flex';
            document.getElementById('findBtn').disabled = false;
            document.getElementById('findBtn').style.opacity = "1";
            
            // ‡ßß ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶¨‡¶ø‡¶∞‡¶§‡¶ø ‡¶¶‡¶ø‡ßü‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶∏‡¶æ‡¶∞‡ßç‡¶ö ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶§‡ßá ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶ì‡ßü‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶™‡¶æ‡ßü
            setTimeout(() => {
                findPartner();
            }, 500);
        }

        socket.on('match_found', () => {
            document.getElementById('input-container').style.display = 'flex';
            document.getElementById('stop-btn-container').style.display = 'block';
            document.getElementById('home-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';
            document.getElementById('messages').innerHTML = "";
            addStatusMessage("‚ú® Connection Established");
        });

        function sendMsg() {
            const inp = document.getElementById('minput');
            if (!inp.value.trim()) return;
            addMessage(inp.value, 'me');
            socket.emit('send_msg', { senderId: userId, text: inp.value });
            inp.value = '';
        }

        socket.on('receive_msg', (data) => {
            addMessage(data.text, 'partner');
            tg.HapticFeedback.notificationOccurred('success');
        });

        socket.on('chat_ended', () => {
            addStatusMessage("üö´ Partner left the conversation.");
            showEndControls();
        });

        function endChatLocal() {
            addStatusMessage("üîí You closed the chat.");
            
            // ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞‡¶ï‡ßá ‡¶¨‡¶≤‡¶æ ‡¶Ø‡ßá ‡¶Ü‡¶Æ‡¶ø ‡¶ö‡ßç‡¶Ø‡¶æ‡¶ü ‡¶õ‡ßá‡ßú‡ßá‡¶õ‡¶ø ‡¶Ø‡¶æ‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßç‡¶ü‡¶®‡¶æ‡¶∞ ‡¶∏‡¶ø‡¶ó‡¶®‡ßç‡¶Ø‡¶æ‡¶≤ ‡¶™‡¶æ‡ßü
            if (userId) {
                socket.emit('leave_chat', userId);
            }
            
            showEndControls();
        }

        function showEndControls() {
            document.getElementById('input-container').style.display = 'none';
            document.getElementById('stop-btn-container').style.display = 'none';
            const controlDiv = document.createElement('div');
            controlDiv.className = 'end-options';
            controlDiv.innerHTML = `
                <button class="btn-next" onclick="findNextPartner()">üîç Find Next Person</button>
                <button class="btn-exit" onclick="location.reload()">üè† Return Home</button>
            `;
            document.getElementById('messages').appendChild(controlDiv);
            scrollDown();
        }

        function findNextPartner() {
            document.getElementById('chat-screen').style.display = 'none';
            document.getElementById('home-screen').style.display = 'flex';
            document.getElementById('findBtn').disabled = false;
            document.getElementById('findBtn').style.opacity = "1";
            findPartner();
        }

        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = `msg ${type}`;
            div.innerText = text;
            document.getElementById('messages').appendChild(div);
            scrollDown();
        }

        function addStatusMessage(text) {
            const p = document.createElement('p');
            p.className = 'status-msg';
            p.innerText = text;
            document.getElementById('messages').appendChild(p);
            scrollDown();
        }

        function scrollDown() {
            const container = document.getElementById('messages');
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>
